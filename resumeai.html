<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Analyzer - Find Your Perfect Opportunity</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            text-decoration: none;
            color: #4a5568;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #667eea;
        }

        .main-content {
            margin-top: 3rem;
        }

        .upload-section {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 2rem;
            color: #2d3748;
            margin-bottom: 1rem;
            text-align: center;
        }

        .section-subtitle {
            color: #718096;
            text-align: center;
            margin-bottom: 2rem;
        }

        .api-key-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .input-label {
            display: block;
            color: #4a5568;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .input-field {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #f8fafc;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #edf2ff;
        }

        .upload-icon {
            font-size: 4rem;
            color: #cbd5e0;
            margin-bottom: 1rem;
        }

        .file-input {
            display: none;
        }

        .file-preview {
            background: #f7fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: none;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-icon {
            font-size: 2rem;
            color: #667eea;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .file-size {
            color: #718096;
            font-size: 0.875rem;
        }

        .remove-btn {
            background: #fc8181;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .remove-btn:hover {
            background: #f56565;
            transform: rotate(90deg);
        }

        .analyze-btn {
            width: 100%;
            margin-top: 2rem;
            padding: 1rem;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .results-section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
        }

        .result-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
        }

        .skill-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .skill-tag {
            background: #edf2ff;
            color: #667eea;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .opportunity-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .opportunity-card:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .opportunity-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .opportunity-company {
            color: #718096;
            margin-top: 0.25rem;
        }

        .match-score {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .opportunity-details {
            display: flex;
            gap: 1.5rem;
            color: #718096;
            font-size: 0.9rem;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .recommendations {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .recommendation-title {
            color: #22543d;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .recommendation-list {
            list-style: none;
        }

        .recommendation-item {
            padding: 0.5rem 0;
            color: #2f855a;
            display: flex;
            align-items: start;
            gap: 0.5rem;
        }

        .export-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .error-message {
            background: #fff5f5;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }

        .success-message {
            background: #f0fff4;
            border: 1px solid #48bb78;
            color: #22543d;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .opportunity-header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .opportunity-details {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="nav">
            <div class="logo">
                <i class="fas fa-robot"></i>
                <span>AI Resume Analyzer</span>
            </div>
            <ul class="nav-links">
                <li><a href="#upload">Upload</a></li>
                <li><a href="#results">Results</a></li>
                <li><a href="#help">Help</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <main class="main-content">
            <!-- Upload Section -->
            <section class="upload-section" id="upload-section">
                <h1 class="section-title">Find Your Perfect Career Match</h1>
                <p class="section-subtitle">Upload your resume and let AI analyze it to find the best opportunities for you</p>
                
                <!-- API Key Input - Hidden since it's hardcoded -->
                <div class="api-key-section" style="display: none;">
                    <label class="input-label">OpenAI API Key (Required)</label>
                    <div class="input-group">
                        <input type="password" id="api-key" class="input-field" placeholder="sk-..." />
                        <button id="save-key-btn" class="btn btn-primary">Save Key</button>
                    </div>
                    <small style="color: #718096;">Your API key is stored locally and never sent to our servers</small>
                </div>

                <!-- File Upload Area -->
                <div class="upload-area" id="upload-area">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <h3>Drop your resume here</h3>
                    <p style="margin: 1rem 0;">or</p>
                    <label for="file-input" class="btn btn-primary">Browse Files</label>
                    <input type="file" id="file-input" class="file-input" accept=".pdf,.doc,.docx,.txt" />
                    <p style="margin-top: 1rem; color: #718096;">Supported formats: PDF, DOC, DOCX, TXT</p>
                </div>

                <!-- File Preview -->
                <div class="file-preview" id="file-preview">
                    <div class="file-info">
                        <i class="fas fa-file-alt file-icon"></i>
                        <div class="file-details">
                            <div class="file-name" id="file-name"></div>
                            <div class="file-size" id="file-size"></div>
                        </div>
                        <button class="remove-btn" id="remove-file">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Analyze Button -->
                <button id="analyze-btn" class="btn btn-primary analyze-btn" disabled>
                    <i class="fas fa-magic"></i> Analyze Resume with AI
                </button>

                <!-- Messages -->
                <div class="error-message" id="error-message"></div>
                <div class="success-message" id="success-message"></div>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="results-section">
                <!-- Loading State -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <h3>Analyzing your resume with AI...</h3>
                    <p style="color: #718096; margin-top: 0.5rem;">This may take a few moments</p>
                </div>

                <!-- Results Content -->
                <div id="results-content" style="display: none;">
                    <h2 class="section-title">Analysis Complete!</h2>
                    
                    <!-- Resume Summary -->
                    <div class="result-card">
                        <h3 class="result-title">Resume Overview</h3>
                        <div id="resume-summary"></div>
                    </div>

                    <!-- Extracted Skills -->
                    <div class="result-card">
                        <h3 class="result-title">Your Skills</h3>
                        <div class="skill-tags" id="skills-list"></div>
                    </div>

                    <!-- Matched Opportunities -->
                    <div class="result-card">
                        <h3 class="result-title">Best Matching Opportunities</h3>
                        <div id="opportunities-list"></div>
                    </div>

                    <!-- AI Recommendations -->
                    <div class="recommendations">
                        <div class="recommendation-title">
                            <i class="fas fa-lightbulb"></i>
                            AI Recommendations
                        </div>
                        <ul class="recommendation-list" id="recommendations-list"></ul>
                    </div>

                    <!-- Export Options -->
                    <div class="export-buttons">
                        <button id="export-pdf" class="btn btn-secondary">
                            <i class="fas fa-file-pdf"></i> Export as PDF
                        </button>
                        <button id="export-json" class="btn btn-secondary">
                            <i class="fas fa-file-code"></i> Export as JSON
                        </button>
                        <button id="new-analysis" class="btn btn-primary">
                            <i class="fas fa-redo"></i> New Analysis
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // State management
        let uploadedFile = null;
        let apiKey = 'YOUR_API_KEY_HERE'; // Replace with your actual API key
        let analysisResults = null;

        // Elements
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const filePreview = document.getElementById('file-preview');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const removeFileBtn = document.getElementById('remove-file');
        const analyzeBtn = document.getElementById('analyze-btn');
        const apiKeyInput = document.getElementById('api-key');
        const saveKeyBtn = document.getElementById('save-key-btn');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const uploadSection = document.getElementById('upload-section');
        const resultsSection = document.getElementById('results-section');
        const loading = document.getElementById('loading');
        const resultsContent = document.getElementById('results-content');

        // API key is hardcoded, no need to initialize or save

        // Drag and drop handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // File input handler
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Remove file handler
        removeFileBtn.addEventListener('click', () => {
            uploadedFile = null;
            filePreview.style.display = 'none';
            uploadArea.style.display = 'block';
            fileInput.value = '';
            updateAnalyzeButton();
        });

        // Handle file upload
        function handleFile(file) {
            const validTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
            const maxSize = 10 * 1024 * 1024; // 10MB

            if (!validTypes.includes(file.type)) {
                showError('Please upload a valid file format (PDF, DOC, DOCX, or TXT)');
                return;
            }

            if (file.size > maxSize) {
                showError('File size must be less than 10MB');
                return;
            }

            uploadedFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            uploadArea.style.display = 'none';
            filePreview.style.display = 'block';
            updateAnalyzeButton();
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Update analyze button state
        function updateAnalyzeButton() {
            analyzeBtn.disabled = !uploadedFile; // Only check for file since API key is hardcoded
        }

        // Extract text from PDF
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }
            
            return fullText;
        }

        // Extract text from DOCX
        async function extractTextFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        // Extract text from file
        async function extractText(file) {
            const fileType = file.type;
            
            try {
                if (fileType === 'application/pdf') {
                    return await extractTextFromPDF(file);
                } else if (fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    return await extractTextFromDOCX(file);
                } else if (fileType === 'text/plain') {
                    return await file.text();
                } else {
                    throw new Error('Unsupported file type');
                }
            } catch (error) {
                console.error('Error extracting text:', error);
                throw error;
            }
        }

        // Analyze resume with ChatGPT
        async function analyzeResume(resumeText) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        {
                            role: 'system',
                            content: 'You are a career counselor AI that analyzes resumes and matches them with job opportunities. Analyze the resume and provide a JSON response with the following structure: {"summary": "2-3 sentence profile summary", "skills": ["skill1", "skill2", ...], "keywords": ["keyword1", "keyword2", ...], "jobTypes": ["internship", "entry-level", "full-time"], "fields": ["computer-science", "data-science", "business"], "recommendations": ["rec1", "rec2", "rec3"]}. Ensure the response is valid JSON without any markdown formatting or backticks.'
                        },
                        {
                            role: 'user',
                            content: `Analyze this resume and provide job matching insights:\n\n${resumeText}`
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 1500
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Failed to analyze resume');
            }

            const data = await response.json();
            let content = data.choices[0].message.content;
            
            // Clean up the response - remove any markdown formatting
            content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            try {
                const parsed = JSON.parse(content);
                // Store the analysis for filtering
                localStorage.setItem('resumeAnalysis', JSON.stringify(parsed));
                return parsed;
            } catch (e) {
                console.error('Failed to parse JSON response:', e);
                // Return a default structure
                const defaultAnalysis = {
                    summary: "Resume analysis completed. Review the matched opportunities below.",
                    skills: extractSkillsFromText(resumeText),
                    keywords: [],
                    jobTypes: ["internship", "entry-level"],
                    fields: ["computer-science"],
                    recommendations: [
                        "Tailor your resume for each application",
                        "Network with professionals in your field",
                        "Continue developing in-demand skills"
                    ]
                };
                localStorage.setItem('resumeAnalysis', JSON.stringify(defaultAnalysis));
                return defaultAnalysis;
            }
        }

        // Extract skills from resume text
        function extractSkillsFromText(text) {
            const commonSkills = ['JavaScript', 'Python', 'Java', 'C++', 'React', 'Node.js', 
                'SQL', 'AWS', 'Git', 'HTML', 'CSS', 'Machine Learning', 'Data Analysis',
                'Project Management', 'Communication', 'Leadership', 'Problem Solving'];
            
            const foundSkills = [];
            const lowerText = text.toLowerCase();
            
            commonSkills.forEach(skill => {
                if (lowerText.includes(skill.toLowerCase())) {
                    foundSkills.push(skill);
                }
            });
            
            return foundSkills.length > 0 ? foundSkills : ['General Skills'];
        }

        // Extract structured data from text response
        function extractStructuredData(text) {
            return {
                summary: "Analysis completed. Please review the recommendations below.",
                skills: ["Skills extracted from resume"],
                opportunities: [
                    {
                        title: "Software Developer",
                        company: "Tech Company",
                        match: 85,
                        reason: "Strong technical skills match"
                    }
                ],
                recommendations: [
                    "Continue developing your skills",
                    "Network with professionals in your field",
                    "Tailor your resume for each application"
                ]
            };
        }

        // Load opportunities data
        async function loadOpportunities() {
            return new Promise((resolve) => {
                // Check if opportunities data is already loaded
                if (window.opportunitiesData) {
                    resolve(window.opportunitiesData);
                } else {
                    // Load the opportunities data script
                    const script = document.createElement('script');
                    script.src = 'opportunities-data.js';
                    script.onload = () => {
                        resolve(window.opportunitiesData || []);
                    };
                    script.onerror = () => {
                        console.error('Failed to load opportunities data');
                        resolve([]);
                    };
                    document.head.appendChild(script);
                }
            });
        }

        // Match opportunities based on resume analysis
        function matchOpportunities(analysis, allOpportunities) {
            const matched = [];
            const skills = (analysis.skills || []).map(s => s.toLowerCase());
            const fields = analysis.fields || [];
            const jobTypes = analysis.jobTypes || [];
            
            allOpportunities.forEach(opp => {
                let score = 0;
                let reasons = [];
                
                // Check job type match
                if (jobTypes.some(type => opp.type && opp.type.includes(type))) {
                    score += 30;
                    reasons.push('Job type matches your experience level');
                }
                
                // Check field/major match
                if (fields.some(field => opp.major && opp.major.includes(field))) {
                    score += 30;
                    reasons.push('Field aligns with your background');
                }
                
                // Check skills match
                if (opp.tags) {
                    const matchedSkills = opp.tags.filter(tag => 
                        skills.some(skill => tag.toLowerCase().includes(skill))
                    );
                    if (matchedSkills.length > 0) {
                        score += Math.min(40, matchedSkills.length * 10);
                        reasons.push(`Matches skills: ${matchedSkills.slice(0, 3).join(', ')}`);
                    }
                }
                
                // Add some randomness for variety
                score += Math.random() * 10;
                
                if (score > 20) {
                    matched.push({
                        ...opp,
                        matchScore: Math.min(95, Math.round(score)),
                        matchReasons: reasons.join('. ')
                    });
                }
            });
            
            // Sort by match score and return top 10
            return matched.sort((a, b) => b.matchScore - a.matchScore).slice(0, 10);
        }

        // Display results
        async function displayResults(results) {
            // Display summary
            document.getElementById('resume-summary').innerHTML = `<p>${results.summary}</p>`;
            
            // Display skills
            const skillsList = document.getElementById('skills-list');
            skillsList.innerHTML = '';
            results.skills.forEach(skill => {
                skillsList.innerHTML += `<span class="skill-tag">${skill}</span>`;
            });
            
            // Load and display matched opportunities
            const allOpportunities = await loadOpportunities();
            const matchedOpportunities = matchOpportunities(results, allOpportunities);
            
            const opportunitiesList = document.getElementById('opportunities-list');
            opportunitiesList.innerHTML = '';
            
            if (matchedOpportunities.length > 0) {
                matchedOpportunities.forEach(opp => {
                    opportunitiesList.innerHTML += `
                        <div class="opportunity-card" data-id="${opp.id}">
                            <div class="opportunity-header">
                                <div>
                                    <div class="opportunity-title">${opp.title}</div>
                                    <div class="opportunity-company">${opp.company}</div>
                                </div>
                                <div class="match-score">${opp.matchScore}% Match</div>
                            </div>
                            <div class="opportunity-details">
                                <div class="detail-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${opp.location ? opp.location.split(',')[0] : 'Jacksonville, FL'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-dollar-sign"></i>
                                    <span>${opp.salary || 'Competitive'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-briefcase"></i>
                                    <span>${opp.type || 'Full-time'}</span>
                                </div>
                            </div>
                            <p style="margin-top: 1rem; color: #718096; font-size: 0.9rem;">
                                ${opp.description ? opp.description.substring(0, 150) + '...' : opp.matchReasons}
                            </p>
                        </div>
                    `;
                });
                
                // Add view all button
                opportunitiesList.innerHTML += `
                    <button id="view-all-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        <i class="fas fa-external-link-alt"></i> View All Matched Opportunities in Main Portal
                    </button>
                `;
                
                // Add click handler for view all button
                setTimeout(() => {
                    const viewAllBtn = document.getElementById('view-all-btn');
                    if (viewAllBtn) {
                        viewAllBtn.addEventListener('click', () => {
                            // Store the filter criteria
                            localStorage.setItem('resumeFilters', JSON.stringify({
                                skills: results.skills,
                                jobTypes: results.jobTypes,
                                fields: results.fields
                            }));
                            // Redirect to main page
                            window.location.href = 'index.html#opportunities';
                        });
                    }
                }, 100);
            } else {
                opportunitiesList.innerHTML = '<p>No specific matches found. Try updating your resume with more keywords.</p>';
            }
            
            // Display recommendations
            const recommendationsList = document.getElementById('recommendations-list');
            recommendationsList.innerHTML = '';
            results.recommendations.forEach(rec => {
                recommendationsList.innerHTML += `
                    <li class="recommendation-item">
                        <i class="fas fa-check-circle"></i>
                        <span>${rec}</span>
                    </li>
                `;
            });
        }

        // Analyze button handler
        analyzeBtn.addEventListener('click', async () => {
            if (!uploadedFile || !apiKey) {
                showError('Please upload a file and provide an API key');
                return;
            }

            try {
                // Show results section with loading
                uploadSection.style.display = 'none';
                resultsSection.style.display = 'block';
                loading.style.display = 'block';
                resultsContent.style.display = 'none';

                // Extract text from file
                const resumeText = await extractText(uploadedFile);
                
                if (!resumeText || resumeText.trim().length < 50) {
                    throw new Error('Could not extract sufficient text from the file');
                }

                // Analyze with ChatGPT
                analysisResults = await analyzeResume(resumeText);
                
                // Display results
                displayResults(analysisResults);
                
                // Show results
                loading.style.display = 'none';
                resultsContent.style.display = 'block';
                
            } catch (error) {
                console.error('Analysis error:', error);
                showError(`Analysis failed: ${error.message}`);
                // Go back to upload section
                uploadSection.style.display = 'block';
                resultsSection.style.display = 'none';
            }
        });

        // New analysis button
        document.getElementById('new-analysis').addEventListener('click', () => {
            uploadedFile = null;
            filePreview.style.display = 'none';
            uploadArea.style.display = 'block';
            fileInput.value = '';
            uploadSection.style.display = 'block';
            resultsSection.style.display = 'none';
            updateAnalyzeButton();
        });

        // Export as JSON
        document.getElementById('export-json').addEventListener('click', () => {
            if (analysisResults) {
                const dataStr = JSON.stringify(analysisResults, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'resume-analysis.json';
                link.click();
                URL.revokeObjectURL(url);
                showSuccess('Analysis exported as JSON');
            }
        });

        // Export as PDF (simplified version - just opens print dialog)
        document.getElementById('export-pdf').addEventListener('click', () => {
            window.print();
            showSuccess('Use the print dialog to save as PDF');
        });

        // Helper functions for messages
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            setTimeout(() => errorMessage.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            setTimeout(() => successMessage.style.display = 'none', 3000);
        }

        // Initialize
        updateAnalyzeButton();
    </script>
</body>
</html>